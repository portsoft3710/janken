<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Cache-Control" content="no-cache">
<meta http-equiv="Expires" content="0">
<meta http-equiv="content-language" content="ja">
<link rel="apple-touch-icon" href="images/icons/icon-152x152.png">
<meta name="apple-mobile-web-app-title" content="じゃんけん">
<title></title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">

<script type="text/javascript" src="./messageBox.js?2020052402"></script>
<link href="css/style.css?2020052601" rel="stylesheet" type="text/css" />
<link href="css/messageBox.css" rel="stylesheet" type="text/css" />
 <link rel="manifest" href="./manifest.json">
<script>
window.addEventListener('load', function() {
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register("./service-worker.js")
      .then(function(registration) {
        console.log("serviceWorker registed.");
      }).catch(function(error) {
        console.log("serviceWorker error.", error);
      });
  }
});
</script>
</head>

<body style="background-color:#fff;">
<link href="https://fonts.googleapis.com/css?family=Kosugi+Maru" rel="stylesheet">

<div id="top" style="background-color:  #66cdaa; padding-top: 5px; padding-bottom: 2px; width: 100%; text-align: center;">
<div class="point-wrapper">
	<div><button type="button" onclick="pointPresent();">Point<br>応募</button></div>
	<div><img src="images/002.png"></div>
    <div><button type="button">詳細</button></div>
</div>
<span class="point" style="position: static;">
<p id="msg"></p></span>
<p style="margin: 0px; font-size: 13px;">100ポイントたまる毎に応募できます</p>
</div>

<!--<div id="midashi1" style="margin-top:0px; width:100%; text-align:center">
	<img src="./images/006.png" style="width:100%;">
</div>-->
<p style="text-align: center;">〜カウントダウンの時間内で選んでね！〜</p>
<div class="wrapper">
<div class="janken-wrapper">
	<p>1回目チャレンジタイム（12:00ごろ）</p>
	<div class="janken"><input type="radio" id="janken1-g" name="janken1">
	<label for="janken1-g" onclick="showMessage('1')"><img src="images/gu.png"></label></div>
	<div class="janken"><input type="radio" id="janken1-c" name="janken1">
	<label for="janken1-c" onclick="showMessage('1')"><img src="images/choki.png"></label></div>
	<div class="janken"><input type="radio" id="janken1-p" name="janken1">
	<label for="janken1-p" onclick="showMessage('1')"><img src="images/pa.png"></label></div>
</div>
<div class="timer" id="timer1" style="text-align: center; margin-top: 0px;"></div>
<div class="janken-wrapper">
	<p>2回目チャレンジタイム（18:00ごろ）</p>
	<div class="janken"><input type="radio" id="janken2-g" name="janken2">
	<label for="janken2-g" onclick="showMessage('2')"><img src="images/gu.png"></label></div>
	<div class="janken"><input type="radio" id="janken2-c" name="janken2">
	<label for="janken2-c" onclick="showMessage('2')"><img src="images/choki.png"></label></div>
	<div class="janken"><input type="radio" id="janken2-p" name="janken2">
	<label for="janken2-p" onclick="showMessage('2')"><img src="images/pa.png"></label></div>
</div>
<div class="timer" id="timer2" style="text-align: center; margin-top: 0px;"></div>
<div class="janken-wrapper">
	<p>3回目チャレンジタイム（23:00ごろ）</p>
	<div class="janken"><input type="radio" id="janken3-g" name="janken3">
	<label for="janken3-g" onclick="showMessage('3')"><img src="images/gu.png"></label></div>
	<div class="janken"><input type="radio" id="janken3-c" name="janken3">
	<label for="janken3-c" onclick="showMessage('3')"><img src="images/choki.png"></label></div>
	<div class="janken"><input type="radio" id="janken3-p" name="janken3">
	<label for="janken3-p" onclick="showMessage('3')"><img src="images/pa.png"></label></div>
</div>
<div class="timer" id="timer3"  style="text-align: center; margin-top: 0px;"></div>
<div class="reload"><button type="button" onclick="reload()">リロード</button></div>
<input type="time" id="resetTime"><button type="button" id="reset" onclick="reset()">リセット</button>
</div>
<footer>
</footer>
<div id="log"></div>
<div id="screenLock"></div>
<div id="messageBox" style="visibility: hidden;">
	<div id="messageBody">確認ダイアログ</div>
	<div id="messageButton">
		<input type="text" id="prompt" style="display: inline;">
		<button id="confirmOk" style="display: inline;">OK</button>
		<button id="confirmCancel" style="display: inline;">キャンセル</button>
	</div>
</div>
<script src="https://npmcdn.com/dexie@latest/dist/dexie.js"></script>
<script type="text/javascript">
var stampIds = '';

var IMG_BASE_URL = './images/';

var MAX_POINT = 200;
var POINT_KEY = 'jankenPoint';
var USER_POINT;
	
var POINT_WIN = 100;
var POINT_DRAW = 10;
var POINT_LOSE = 5;

var CHANGE_POINT = 100;
var RESULT_MESSAGE = {}
RESULT_MESSAGE[POINT_WIN] = '勝ちました！　おめでとう';
RESULT_MESSAGE[POINT_DRAW] = 'あいこでした。。';
RESULT_MESSAGE[POINT_LOSE] = '残念。。　負けました';

//ジャンケンを選択できる時間(何時～何時まで)
var JANKEN_TIME1_FROM = new Date(new Date().setHours(0, 0, 0));
var JANKEN_TIME1_TO = new Date(new Date().setHours(23, 00, 0));
var JANKEN_TIME2_FROM = new Date(new Date().setHours(12, 00, 01));
var JANKEN_TIME2_TO = new Date(new Date().setHours(23, 00, 0));
var JANKEN_TIME3_FROM = new Date(new Date().setHours(18, 00, 01));
var JANKEN_TIME3_TO = new Date(new Date().setHours(23, 00, 0));

var JANKEN_G = 'JANKEN_G';
var JANKEN_C = 'JANKEN_C';
var JANKEN_P = 'JANKEN_P';

var JANKEN_TIME1 = {time: new Date(new Date().setHours(22, 30, 0)), hand: JANKEN_G};
var JANKEN_TIME2 = {time: new Date(new Date().setHours(22, 31, 0)), hand: JANKEN_C};
var JANKEN_TIME3 = {time: new Date(new Date().setHours(22, 32, 0)), hand: JANKEN_P};

// RESETがtrueの場合リセット→ RESET_TIME以前の時間に取得したトリガーは無効として扱う
var RESET = true;
var RESET_TIME = new Date(new Date().setHours(10, 17, 0));
	
//storageInit();
var db = new Dexie("jankenDB");
db.version(1).stores({
    storage: "storageKey, storageValue"
});
/*db.storage.bulkPut([
		{storageKey: "jankenReset"},
		{storageKey: "jankenResult1"},
		{storageKey: "jankenResult2"},
		{storageKey: "jankenResult3"},
		{storageKey: POINT_KEY, storageValue: 99}]);
*/
const data = db.storage.toArray().then(function(storage){
	for(let data of storage){
		if(data.storageValue){
			localStorage.setItem(data.storageKey, data.storageValue);
		}
	}
	bodyOnload();
});
function bodyOnload(){
    db.storage.delete('pointChnage');
    localStorage.removeItem('pointChnage');
	if(RESET){
		db.storage.put({storageKey: 'jankenReset', storageValue: RESET_TIME});
        localStorage.setItem('jankenReset', RESET_TIME);
        
		for(let i = 1; i <= 3; i++){
			if(localStorage.getItem('jankenResult' + i)){
				const result = JSON.parse(localStorage.getItem('jankenResult' + i));
                if(result['resultTime']){
                    if(new Date(result['resultTime']) < new Date(RESET_TIME)){
                        delete result['point'];
                    }
                }
                if(result['jankenTime']){
                    if(new Date(result['jankenTime']) < new Date(RESET_TIME)){
                        delete result['jankenTime'];
                        if(result['selected']){
                            delete result['selected'];                           
                       }
                    }
                }
                db.storage.put({storageKey: 'jankenResult' + i, storageValue: JSON.stringify(result)});
                localStorage.setItem('jankenResult' + i, JSON.stringify(result));
			}
		}
	}
    init();
	countdownTimer();
}
function init() {
	const today00 = new Date(new Date().setHours(0, 0, 0, 0));
	for(let i = 1; i <= 3; i++){
		$('janken' + i + '-g').value = JANKEN_G;
		$('janken' + i + '-c').value = JANKEN_C;
		$('janken' + i + '-p').value = JANKEN_P;

		if(localStorage.getItem('jankenResult' + i)){
			const result = JSON.parse(localStorage.getItem('jankenResult' + i));
			if(new Date(result['jankenTime']) < today00){
                db.storage.delete('jankenResult' + i);
				localStorage.removeItem('jankenResult' + i);
			}
			else{
				const selectedJanken = result['selected'];
				const jankenRadio = document.getElementsByName('janken' + i);
				if(selectedJanken){
					for(let j = 0; j < jankenRadio.length; j++){
						jankenRadio[j].disabled = true;
						if(selectedJanken == jankenRadio[j].value){
							jankenRadio[j].checked = true;
						}
					}                        
				}
			}
		}
	}
	dispCurrentPoint();
}


function doJanken(jankenNum){
	if(localStorage.getItem('jankenResult' + jankenNum)){
		const result = JSON.parse(localStorage.getItem('jankenResult' + jankenNum));
		if('point' in result == false){
			result['point'] = checkJanken(jankenNum);
			result['resultTime'] = new Date();
			// ポイント付与
			let curretPoint = 0;
			if(localStorage.getItem(POINT_KEY)){
				curretPoint = localStorage.getItem(POINT_KEY) * 1;
			}
			curretPoint+= result['point'] * 1;

            db.storage.put({storageKey: 'jankenResult' + jankenNum, storageValue: JSON.stringify(result)});
            db.storage.put({storageKey: POINT_KEY, storageValue: curretPoint});
			
            localStorage.setItem('jankenResult' + jankenNum, JSON.stringify(result));
            localStorage.setItem(POINT_KEY, curretPoint);
            pointUse(curretPoint);
			MessageBox.Alert(
				RESULT_MESSAGE[result['point']] + '<br>' + result['point'] + 'ポイント獲得しました。',
				function(){
				}
			);
		}
	}
	else{
		const result = {};
		result['point'] = 0;
		result['resultTime'] = new Date();
        db.storage.put({storageKey: 'jankenResult' + jankenNum, storageValue: JSON.stringify(result)});
		localStorage.setItem('jankenResult' + jankenNum, JSON.stringify(result));
	}
}

function checkJanken(jankenNum){
	let janken_hand;
	if(jankenNum == 1){
		janken_hand = JANKEN_TIME1['hand'];
	}
	else if(jankenNum == 2){
		janken_hand = JANKEN_TIME2['hand'];
	}
	else if(jankenNum == 3){
		janken_hand = JANKEN_TIME3['hand'];
	}
	const jankenRadio = document.getElementsByName('janken' + jankenNum);
	let selectedJanken;
	let point;
	for(let i = 0;i < jankenRadio.length; i++){
		if(jankenRadio[i].checked){
			selectedJanken = jankenRadio[i].value;
		}
	}
	if(!selectedJanken){
		point = POINT_LOSE;
	}
	else{
		if(selectedJanken == janken_hand){
			point = POINT_DRAW;
		}
		else{
			if(selectedJanken == JANKEN_G && janken_hand == JANKEN_C){
				point = POINT_WIN;
			}
			else if(selectedJanken == JANKEN_G && janken_hand == JANKEN_P){
				point = POINT_LOSE;
			}
			else if(selectedJanken == JANKEN_C && janken_hand == JANKEN_G){
				point = POINT_LOSE;
			}
			else if(selectedJanken == JANKEN_C && janken_hand == JANKEN_P){
				point = POINT_WIN;
			}
			else if(selectedJanken == JANKEN_P && janken_hand == JANKEN_G){
				point = POINT_WIN;
			}
			else if(selectedJanken == JANKEN_P && janken_hand == JANKEN_C){
				point = POINT_LOSE;
			}
		}
	}
	return point;
}
function pointUse(point){
	let currentPoint = 0;
	if(localStorage.getItem(POINT_KEY)){
		currentPoint = localStorage.getItem(POINT_KEY) * 1;
	}
	currentPoint+=point;
	dispCurrentPoint();
}
function pointPresent(){
    let currentPoint = 0;
	if(localStorage.getItem(POINT_KEY)){
		currentPoint = localStorage.getItem(POINT_KEY) * 1;
	}    
	if(currentPoint >= CHANGE_POINT){
		MessageBox.Confirm(
			"特典と本当に交換しますか？<br>（OKの場合はスタッフに見せながら）",
			function(){
                location.href='ok.html';
			},
			function(){}
		);
    }
    else{
		MessageBox.Alert(
			"まだ" + CHANGE_POINT + "ポイントたまっていません",
			function(){
			}
        );
    }
}

function dispCurrentPoint(){

	if(localStorage.getItem(POINT_KEY) && localStorage.getItem(POINT_KEY) * 1 > MAX_POINT){
		db.storage.put({storageKey: POINT_KEY, storageValue: MAX_POINT});
		localStorage.setItem(POINT_KEY, MAX_POINT);
	}
	if(localStorage.getItem(POINT_KEY)){
		document.getElementById('msg').innerHTML = localStorage.getItem(POINT_KEY) + ' point';
	}
	else{
		document.getElementById('msg').innerHTML = '0 point';
	}
}

function $(id){return document.getElementById(id);}
function $S(id){return $(id).style;}
function $V(id){$S(id).visibility = 'visible';}
function $H(id){$S(id).visibility = 'hidden';}
function $I(id){$S(id).display = 'inline';}
function $N(id){$S(id).display = 'none';}
function srcUrl(fn){return (fn + '?' + new Date().getTime());}
function $log(m){
	//$('log').insertAdjacentHTML('beforeend', '<br>' + m);
	document.getElementById('log').insertAdjacentHTML('beforeend', '<br>' + m);
}
var popupopen = function(){
	document.getElementById("howtoPopup").style.display="block";
}
var popupclose = function(){
	document.getElementById("howtoPopup").style.display="none";
}


function reset(){
	const resetValue = $('resetTime').value;
	if(resetValue !== ''){
		const resetTime = new Date(new Date().setHours(resetValue.split(':')[0] * 1, resetValue.split(':')[1] * 1, 0, 0));
        db.storage.put({storageKey: 'jankenReset', storageValue: resetTime});
		localStorage.setItem('jankenReset', resetTime);
		for(let i = 1; i <= 3; i++){
			if(localStorage.getItem('jankenResult' + i)){
                db.storage.delete('jankenResult' + i);
				localStorage.removeItem('jankenResult' + i);
			}
		}
        MessageBox.Alert(
            "リセットしました",
            function(){
            }
        );        
	}
}
function showMessage(jankenNum){
	const now = new Date();
	let janken_time_from;
	let janken_time_to;
    let janken_time;
	if(jankenNum == 1){
		janken_time_from = JANKEN_TIME1_FROM;
		janken_time_to = JANKEN_TIME1_TO;
        janken_time = JANKEN_TIME1;
	}
	else if(jankenNum == 2){
		janken_time_from = JANKEN_TIME2_FROM;
		janken_time_to = JANKEN_TIME2_TO;
        janken_time = JANKEN_TIME2;
	}
	else if(jankenNum == 3){
		janken_time_from = JANKEN_TIME3_FROM;
		janken_time_to = JANKEN_TIME3_TO;
        janken_time = JANKEN_TIME3;
	}
	
	if(now < janken_time_from || janken_time_to < now){
		$('confirmOk').textContent = 'OK';
		MessageBox.Alert(
			"只今の時間はじゃんけんを選択できません",
			function(){}
		);
	}
	else{
		let selectedFlg = false;
		if(localStorage.getItem('jankenResult' + jankenNum)){
			const result = JSON.parse(localStorage.getItem('jankenResult' + jankenNum));
			if(result['selected']){
				selectedFlg = true;
			}
		}
		if(selectedFlg){
            const jankenRadio = document.getElementsByName('janken' + jankenNum);
            for(let i = 0;i < jankenRadio.length; i++){
                jankenRadio[i].disabled = true;
            }
            MessageBox.Alert(
				"選択後には変更出来ません",
				function(){
				}
			);
		}
		else{
            if(janken_time['time'] < now){
                MessageBox.Alert(
                    "じゃんけんの時間が過ぎています",
                    function(){
                        const jankenRadio = document.getElementsByName('janken' + jankenNum);
                        for(let i = 0;i < jankenRadio.length; i++){
                            jankenRadio[i].checked = false;
                            jankenRadio[i].disabled = true;
                        }
                    }
                );
            }
            else{
			MessageBox.Confirm(
			"このじゃんけんで決定しますか？", 
			function(){
				const jankenRadio = document.getElementsByName('janken' + jankenNum);
                let result;
                if(localStorage.getItem('jankenResult' + jankenNum)){
                    result = JSON.parse(localStorage.getItem('jankenResult' + jankenNum));
                }
                else{
                    result = {};
                }
				result['jankenTime'] = new Date();
				for(let i = 0;i < jankenRadio.length; i++){
					if(jankenRadio[i].checked){
						result['selected'] = jankenRadio[i].value;
						db.storage.put({storageKey: 'jankenResult' + jankenNum, storageValue: JSON.stringify(result)});
						localStorage.setItem('jankenResult' + jankenNum, JSON.stringify(result));
					}
					jankenRadio[i].disabled = true;
				}
			},
			function(){                
                const jankenRadio = document.getElementsByName('janken' + jankenNum);
				for(let i = 0;i < jankenRadio.length; i++){
					jankenRadio[i].checked = false;
				}
            }
			);                
            }
		}
	}
}
function countdownTimer(){
	const now = new Date();
	for(let i = 1; i <= 3; i++){
		let janken_time_from;
		let janken_time_to;
		let janken_time;
		if(i == 1){
			janken_time_from = JANKEN_TIME1_FROM;
			janken_time_to = JANKEN_TIME1_TO;
			janken_time = JANKEN_TIME1;
		}
		else if(i == 2){
			janken_time_from = JANKEN_TIME2_FROM;
			janken_time_to = JANKEN_TIME2_TO;
			janken_time = JANKEN_TIME2;
		}
		else if(i == 3){
			janken_time_from = JANKEN_TIME3_FROM;
			janken_time_to = JANKEN_TIME3_TO;
			janken_time = JANKEN_TIME3;
		}
		
		let insert = '';
		let disabledFlg = true;
		if(janken_time_from <= now && now <= janken_time_to){
			let period = janken_time_to - now ;
			const addZero = function(n){return('0'+n).slice(-2);}
			const addZeroDay = function(n){return('0'+n).slice(-3);}
			if(period >= 0) {
				const day = Math.floor(period / (1000 * 60 * 60 * 24));
				period -=  (day　*(1000 * 60 * 60 * 24));
				const hour = Math.floor(period / (1000 * 60 * 60));
				period -= (hour *(1000 * 60 * 60));
				const minutes =  Math.floor(period / (1000 * 60));
				period -= (minutes * (1000 * 60));
				const second = Math.floor(period / 1000);
				if(hour > 0) insert = '<span class="h">' + addZero(hour) + '時間'+'</span>';
				if(minutes > 0) insert +=  '<span class="m">' + addZero(minutes) +'分' + '</span>';
				insert += '<span class="s">' + addZero(second)+ '秒'+ '</span>';
                insert = '選択終了まで残り ' + insert;
				disabledFlg = false;
			
			}
			else{
				insert = '選択終了まで残り --時間--分--秒';
			}
		}
		else{
			insert = '選択終了まで残り --時間--分--秒';			
		}
		$('timer' + i).innerHTML = insert;
		const jankenRadio = document.getElementsByName('janken' + i);
		for(let i = 0;i < jankenRadio.length; i++){
			jankenRadio[i].disabled = disabledFlg;
		}
		if(janken_time['time'] <= now){
			doJanken(i);
		}
	}
	setTimeout(countdownTimer, 10);
}
function reload(){
    location.reload();
}
</script>
</body>
</html>
